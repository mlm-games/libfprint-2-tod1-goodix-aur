name: Check and Update libfprint-2-tod1-goodix

on:
  schedule:
    - cron: '0 0 * */2 *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if version unchanged'
        required: false
        default: false
        type: boolean
      increment_pkgrel:
        description: 'Increment pkgrel (for same version updates)'
        required: false
        default: false
        type: boolean

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip jq
        pip3 install requests beautifulsoup4
    
    - name: Check for updates from Launchpad
      id: check
      run: |
        # Create inline Python script to check versions
        cat > check_version.py << 'EOF'
        import requests
        from bs4 import BeautifulSoup
        import re
        import json
        import sys
        
        LAUNCHPAD_URL="https://launchpad.net/~libfprint-tod1-group/+archive/ubuntu/ppa/+packages"
        PACKAGE_NAME = "libfprint-2-tod1-goodix"
        
        def get_latest_version():
            try:
                response = requests.get(LAUNCHPAD_URL, timeout=30)
                if response.status_code != 200:
                    print(f"Error: HTTP {response.status_code}", file=sys.stderr)
                    return None
                
                soup = BeautifulSoup(response.text, 'html.parser')
                
                # Debug: print first few characters of response
                print(f"Response received, length: {len(response.text)}", file=sys.stderr)
                
                for row in soup.find_all('tr'):
                    if PACKAGE_NAME in str(row):
                        # Try multiple regex patterns
                        patterns = [
                            rf'{PACKAGE_NAME}\s+(\d+\.\d+\.\d+\+\d+-\d+ubuntu\d+)',
                            rf'{PACKAGE_NAME}.*?(\d+\.\d+\.\d+\+\d+-\d+ubuntu\d+)',
                            rf'(\d+\.\d+\.\d+\+\d+-\d+ubuntu\d+)'
                        ]
                        
                        for pattern in patterns:
                            version_match = re.search(pattern, str(row))
                            if version_match:
                                return version_match.group(1)
                
                print(f"Package {PACKAGE_NAME} not found in page", file=sys.stderr)
                return None
                
            except Exception as e:
                print(f"Exception: {str(e)}", file=sys.stderr)
                return None
        
        latest = get_latest_version()
        if latest:
            # Extract just the version number without ubuntu suffix for pkgver
            pkgver = latest.split('-')[0]
            result = {
                "full_version": latest,
                "pkgver": pkgver
            }
            print(json.dumps(result))
            sys.exit(0)
        else:
            print("Failed to get version", file=sys.stderr)
            sys.exit(1)
        EOF
        
        # Run the script and capture output
        if python3 check_version.py > version_output.json 2> error.log; then
          VERSION_INFO=$(cat version_output.json)
          echo "Version info retrieved successfully"
        else
          echo "Python script failed. Error log:"
          cat error.log
          
          # Fallback: try with curl and grep
          echo "Trying fallback method..."
          LATEST_FULL=$(curl -s "$LAUNCHPAD_URL" | grep -oP 'libfprint-2-tod1-goodix-550a_\K[0-9.+\-]+ubuntu[0-9]+' | head -1)
          
          if [ -n "$LATEST_FULL" ]; then
            LATEST_PKGVER=$(echo "$LATEST_FULL" | cut -d'-' -f1)
            VERSION_INFO=$(echo "{\"full_version\": \"$LATEST_FULL\", \"pkgver\": \"$LATEST_PKGVER\"}")
            echo "Fallback method succeeded: $VERSION_INFO"
          else
            echo "Both methods failed to fetch version info"
            exit 1
          fi
        fi
        
        LATEST_FULL=$(echo "$VERSION_INFO" | jq -r '.full_version')
        LATEST_PKGVER=$(echo "$VERSION_INFO" | jq -r '.pkgver')
        
        echo "Latest version: $LATEST_FULL"
        echo "latest_version=$LATEST_FULL" >> $GITHUB_OUTPUT
        echo "pkgver=$LATEST_PKGVER" >> $GITHUB_OUTPUT
        
        # Get current version from local PKGBUILD or AUR
        CURRENT_PKGVER=""
        if [ -f PKGBUILD ]; then
          CURRENT_PKGVER=$(grep "^pkgver=" PKGBUILD | cut -d= -f2)
        fi
        
        if [ -z "$CURRENT_PKGVER" ]; then
          # Try AUR
          CURRENT_PKGVER=$(curl -fsSL "https://aur.archlinux.org/cgit/aur.git/plain/PKGBUILD?h=libfprint-2-tod1-goodix-v2" \
            | awk -F= '/^[[:space:]]*pkgver[[:space:]]*=/ {print $2; exit}')
        fi
        
        echo "Current pkgver: $CURRENT_PKGVER"
        echo "current_pkgver=$CURRENT_PKGVER" >> $GITHUB_OUTPUT
        
        if [[ "$LATEST_PKGVER" != "$CURRENT_PKGVER" ]] || [[ "${{ inputs.force_update }}" == "true" ]]; then
          echo "update_needed=true" >> $GITHUB_OUTPUT
        else
          echo "update_needed=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Download and calculate checksum
      if: steps.check.outputs.update_needed == 'true'
      id: download
      run: |
        DEB_URL="https://launchpad.net/~libfprint-tod1-group/+archive/ubuntu/ppa/+files/libfprint-2-tod1-goodix-550a_${{ steps.check.outputs.latest_version }}_amd64.deb"
        echo "Downloading from: $DEB_URL"
        wget -O temp.deb "$DEB_URL"
        CHECKSUM=$(sha256sum temp.deb | cut -d ' ' -f 1)
        echo "sha256sum=$CHECKSUM" >> $GITHUB_OUTPUT
        rm temp.deb
    
    - name: Get current pkgrel from AUR
      if: steps.check.outputs.update_needed == 'true'
      id: current_pkgrel
      run: |
        # Try to get current PKGBUILD from AUR
        CURRENT_PKGREL=$(curl -s "https://aur.archlinux.org/cgit/aur.git/plain/PKGBUILD?h=libfprint-2-tod1-goodix-v2" | grep "^pkgrel=" | cut -d= -f2 || echo "0")
        echo "current_pkgrel=$CURRENT_PKGREL" >> $GITHUB_OUTPUT
        
        # Check if the version in AUR matches what we're updating to
        AUR_VERSION=$(curl -s "https://aur.archlinux.org/cgit/aur.git/plain/PKGBUILD?h=libfprint-2-tod1-goodix-v2" | grep "^pkgver=" | cut -d= -f2 || echo "none")
        if [[ "$AUR_VERSION" == "${{ steps.check.outputs.pkgver }}" ]]; then
          echo "same_version=true" >> $GITHUB_OUTPUT
        else
          echo "same_version=false" >> $GITHUB_OUTPUT
        fi
      continue-on-error: true
    
    - name: Determine pkgrel
      if: steps.check.outputs.update_needed == 'true'
      id: pkgrel
      run: |
        if [[ "${{ steps.current_pkgrel.outputs.same_version }}" == "true" ]] && [[ "${{ inputs.increment_pkgrel }}" == "true" ]]; then
          CURRENT=${{ steps.current_pkgrel.outputs.current_pkgrel }}
          NEW_PKGREL=$((CURRENT + 1))
          echo "pkgrel=$NEW_PKGREL" >> $GITHUB_OUTPUT
        else
          echo "pkgrel=1" >> $GITHUB_OUTPUT
        fi
    
    - name: Create PKGBUILD
      if: steps.check.outputs.update_needed == 'true'
      run: |
        mkdir -p aur-package
        cat > aur-package/PKGBUILD << 'EOF'
        # Maintainer: MLM-stuff gfxoxinzh@mozmail.com
        
        pkgname=libfprint-2-tod1-goodix-v2
        pkgver=${{ steps.check.outputs.pkgver }}
        _debver="${pkgver}-0ubuntu1"
        _debname="libfprint-2-tod1-goodix-550a"
        pkgrel=${{ steps.pkgrel.outputs.pkgrel }}
        pkgdesc="Proprietary driver for Goodix fingerprint readers from Ubuntu launchpad"
        arch=('x86_64')
        url="https://launchpad.net/~libfprint-tod1-group"
        license=('custom')
        conflicts=('libfprint-2-tod1-goodix')
        depends=('libfprint-tod')
        makedepends=('tar')
        groups=('fprint')
        source=("https://launchpad.net/~libfprint-tod1-group/+archive/ubuntu/ppa/+files/${_debname}_${_debver}_amd64.deb")
        sha256sums=('${{ steps.download.outputs.sha256sum }}')
        
        prepare() {
            cd "$srcdir"
            ar x "${_debname}_${_debver}_amd64.deb"
            tar -xf data.tar.*
        }
        
        package() {
            cd "$srcdir"
            
            # Adjust udev rules for Arch (replace plugdev with uaccess, rm unnecessary ATTRS{dev})
            if [ -f "lib/udev/rules.d/60-libfprint-2-tod1-goodix.rules" ]; then
                sed -i 's/, ATTRS{dev}=="\*"//' lib/udev/rules.d/60-libfprint-2-tod1-goodix.rules
                sed -i 's/GROUP="plugdev"/TAG+="uaccess"/' lib/udev/rules.d/60-libfprint-2-tod1-goodix.rules
            fi
            
            # Install library files
            if [ -d "usr/lib/x86_64-linux-gnu/libfprint-2/tod-1" ]; then
                install -dm755 "$pkgdir/usr/lib/libfprint-2/tod-1/"
                install -Dm755 usr/lib/x86_64-linux-gnu/libfprint-2/tod-1/*.so "$pkgdir/usr/lib/libfprint-2/tod-1/"
            fi
            
            # Install udev rules
            if [ -d "lib/udev/rules.d" ]; then
                install -dm755 "$pkgdir/usr/lib/udev/rules.d/"
                install -Dm644 lib/udev/rules.d/*.rules "$pkgdir/usr/lib/udev/rules.d/"
            fi
            
            # Install license if present
            if [ -f "usr/share/doc/${_debname}/copyright" ]; then
                install -Dm644 "usr/share/doc/${_debname}/copyright" "$pkgdir/usr/share/licenses/${pkgname}/LICENSE"
            fi
        }
        EOF
    
    - name: Publish to AUR
      if: steps.check.outputs.update_needed == 'true'
      uses: mlm-games/aur-deploy-action@master
      with:
        pkgname: libfprint-2-tod1-goodix-v2
        pkgbuild: aur-package/PKGBUILD
        commit_username: MLM-stuff
        commit_email: gfxoxinzh@mozmail.com
        ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
        commit_message: "Update to version ${{ steps.check.outputs.pkgver }}-${{ steps.pkgrel.outputs.pkgrel }}"
    
    # - name: Update repository files (redundant)
    #   if: steps.check.outputs.update_needed == 'true'
    #   run: |
    #     # Update README (not anymore)
    #     git config --local user.email "github-actions[bot]@users.noreply.github.com"
    #     git config --local user.name "github-actions[bot]"

    #     git commit -m "Update to version ${{ steps.check.outputs.pkgver }}" || echo "No changes to commit"
    #     git push || echo "No changes to push"
